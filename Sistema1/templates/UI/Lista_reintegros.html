{% extends "UI/base.html" %}
{% load static %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Bootstrap CSS link -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktUqb9K2Q7Zt27H73uV+eI1JtG/M4x4xBvryhGK8n" crossorigin="anonymous">

<!-- Font Awesome CSS for Icons -->
 <!-- Custom CSS -->


<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    .table-responsive {
        max-height: 400px; /* Limitar la altura de la tabla con scroll */
        overflow-y: auto;
    }

    canvas {
        max-width: 100%; /* Asegurar que el gráfico no se desborde */
        height: auto;
    }

    @media (max-width: 768px) {
        /* Para pantallas pequeñas, mostrar en columnas */
        .table-responsive, canvas {
            margin-bottom: 1rem;
        }
    }
</style>


<!-- Content -->
<div class="container-fluid mt-4">
   

    <!-- Button and Search Form -->
    <div class="d-flex justify-content-between align-items-center px-4">
        <!-- Add Municipality Button -->
        <a class="btn btn-light" href="{% url 'Agregar_Reintegros' %}"><i class="fas fa-plus"></i> Agregar reintegros</a>
        
        <!-- Search Form -->
        <form class="d-flex" role="search" method="get">
                <input class="form-control me-2" type="search" placeholder="Buscar" name="buscar" aria-label="Search">
            <button class="btn btn-outline-dark" type="submit"><i class="fas fa-search"></i> <!-- Ícono de búsqueda --></button>
        </form>
    </div>

    <div class="mt-4">
    <form method="GET" action="{% url 'Listar_Reintegros' %}">
            <!-- Filtro de Convenio -->
    <label for="convenio">Convenio</label>
    <select name="convenio" id="convenio">
        <option value="">Seleccione un convenio</option>
        {% for convenio in convenios %}
        <option value="{{ convenio.id }}" {% if convenio.id == request.GET.convenio %}selected{% endif %}>
            {{ convenio.nombre }}
        </option>
        {% endfor %}
    </select>

    <!-- Filtro de Municipio -->
    <label for="municipio">Municipio</label>
    <select name="municipio" id="municipio">
        <option value="">Seleccione un municipio</option>
        {% for municipio in municipios %}
            <option value="{{ municipio.nombre }}" {% if municipio.nombre == request.GET.municipio %}selected{% endif %}>
                {{ municipio.nombre }}
            </option>
        {% endfor %}
    </select>
        
        <label for="fecha_inicio">Fecha Inicio:</label>
        <input type="date" name="fecha_inicio" id="fecha_inicio">
        
        <label for="fecha_fin">Fecha Fin:</label>
        <input type="date" name="fecha_fin" id="fecha_fin">
    
        <button type="submit">Filtrar</button>
    </form>
</div>



<div class="row mt-3">
    <!-- Tabla de municipios -->
    <div class="col-md-8">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="text-center">
                    <tr>
                        <th>Convenio</th>
                        <th>Código Referencia</th>
                        <th>Monto Entregado</th>
                        <th>Monto Reintegrar</th>
                        <th>Fecha Límite Devolución</th>
                        <th>Doc</th>
                        <th>Opciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reintegros %}
                        {% for m in reintegros %}
                        <tr>
                            <td>{{ m.convenio }}</td>
                            <td>{{ m.codigo_referencia }}</td>
                            <td>{{ m.monto_entregado }}</td>
                            <td>{{ m.monto_reintegrar }}</td>
                            <td>{{ m.fecha_limite_devolucion }}</td>
                            <td class="text-center">
                                <a href="{{ m.documento.url }}" target="_blank" class="btn btn-link text-primary" title="Ver documento">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </a>
                            </td>
                            <td class="text-center">
                                <a href="{% url 'Actualizar_Reintegros' id=m.id %}" class="btn btn-link text-warning" title="Actualizar">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="btn btn-link text-danger" title="Eliminar" onclick="confirmDelete('{% url 'breintegro' id=m.id %}')">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center">No se encuentran municipios</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Gráfico Circular -->
    <div class="col-md-4 d-flex align-items-center justify-content-center">
        <div>
            <canvas id="graficoCircular"></canvas>
        </div>
    </div>
</div>


    <!-- Paginación -->
    <div class="row">
        <div class="col-12 text-center">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center">
                    {% if reintegros.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ reintegros.previous_page_number }}" aria-label="Anterior">
                            Anterior
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Anterior</span>
                    </li>
                    {% endif %}

                    {% for num in reintegros.paginator.page_range %}
                    <li class="page-item {% if reintegros.number == num %}active{% endif %}">
                        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                    </li>
                    {% endfor %}

                    {% if reintegros.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ reintegros.next_page_number }}" aria-label="Siguiente">
                            Siguiente
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Siguiente</span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>  


</div>

<script>
    // Datos desde el contexto
    const totalEntregado = {{ total_entregado }};
    const totalReintegrar = {{ total_reintegrar }};

    // Crear gráfico circular
    const ctx = document.getElementById('graficoCircular').getContext('2d');
    new Chart(ctx, {
        type: 'pie', // Tipo de gráfico circular
        data: {
            labels: ['Monto Entregado', 'Monto Reintegrar'],
            datasets: [{
                data: [totalEntregado, totalReintegrar], // Datos en porcentaje
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)', // Azul para entregado
                    'rgba(255, 99, 132, 0.6)'  // Rojo para reintegrar
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)', // Bordes
                    'rgba(255, 99, 132, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = totalEntregado + totalReintegrar;
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(2);
                            return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
</script>



<script>
    function confirmDelete(deleteUrl) {
      Swal.fire({
        title: '¿Estás seguro?',
        text: "Esta acción no se puede deshacer.",
        icon: 'warning', // Ícono de advertencia
        showCancelButton: true, // Botón de cancelar
        confirmButtonColor: '#d33', // Color del botón de confirmar
        cancelButtonColor: '#6c757d', // Color del botón de cancelar
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        backdrop: true, // Fondo semi-transparente
        allowOutsideClick: false, // Desactiva clics fuera del modal
      }).then((result) => {
        if (result.isConfirmed) {
          // Redirige al enlace de eliminación
          window.location.href = deleteUrl;
        }
      });
    }
  </script>
  
  

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

{% endblock %}
